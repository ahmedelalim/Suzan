<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>تصريح دخول</title>

<style>
    body {
        background: #eee;
        display: flex;
        flex-direction: column;
        align-items: center;
        font-family: "Arial", sans-serif;
        padding: 20px;
    }

    textarea {
        width: 90%;
        height: 150px;
        margin-bottom: 15px;
        font-size: 18px;
        padding: 10px;
    }

    button {
        padding: 12px 20px;
        font-size: 18px;
        margin-bottom: 10px;
        cursor: pointer;
    }

    .page {
        width: 210mm;
        height: 297mm;
        background-image: url("background.jpg");
        background-size: 100% 100%; /* fit entire page */
        background-repeat: no-repeat;
        background-position: center;
        position: relative;
        padding: 25mm;
        box-sizing: border-box;
        display: none;
    }

    .date {
        position: absolute;
        top: 40mm;   
        left: 40mm;  
        font-size: 16px;
    }

    .text-box {
        position: absolute;
        top: 60mm;  /* start of text */
        right: 25mm;
        left: 25mm;
        bottom: 60mm; /* bottom limit */
        white-space: pre-wrap;
        font-size: 20px;
        line-height: 1.6;
    }
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

</head>
<body>

<textarea id="inputText" placeholder="اكتب النص هنا..."></textarea>

<button onclick="generatePDF()">تحميل صفحة PDF</button>
<button onclick="sharePDF()">شارك PDF</button>

<div class="page" id="page">
    <div class="date" id="dateArea"></div>
    <div class="text-box" id="outputText"></div>
</div>

<script>
const lineHeight = 10; // approx height per line in mm
const topPadding = 60;  // top in mm
const bottomPadding = 60; // bottom in mm
const pageHeight = 297;  // A4 height in mm
const usableHeight = pageHeight - topPadding - bottomPadding;

function splitTextIntoPages(text) {
    const lines = text.split(/\n/);
    const maxLinesPerPage = Math.floor(usableHeight / lineHeight);
    const pages = [];

    for (let i = 0; i < lines.length; i += maxLinesPerPage) {
        pages.push(lines.slice(i, i + maxLinesPerPage).join("\n"));
    }

    return pages;
}

async function renderPageToPDF(text, pdf) {
    const pageElement = document.getElementById("page");
    const dateArea = document.getElementById("dateArea");
    const outputText = document.getElementById("outputText");

    outputText.innerText = text;
    const today = new Date().toLocaleDateString('ar-EG');
    dateArea.innerText = today;

    pageElement.style.display = "block";
    const canvas = await html2canvas(pageElement, { scale: 3 });
    const imgData = canvas.toDataURL("image/png");

    const { jsPDF } = window.jspdf;
    if(!pdf) pdf = new jsPDF("p", "mm", "a4");
    pdf.addImage(imgData, "PNG", 0, 0, 210, 297);

    return pdf;
}

async function generatePDF() {
    const text = document.getElementById("inputText").value;
    const pages = splitTextIntoPages(text);

    let pdf;
    for(let i = 0; i < pages.length; i++) {
        pdf = await renderPageToPDF(pages[i], pdf);
        if(i < pages.length - 1) pdf.addPage();
    }

    pdf.save("تصريح دخول.pdf");
}

async function sharePDF() {
    const text = document.getElementById("inputText").value;
    const pages = splitTextIntoPages(text);

    let pdf;
    for(let i = 0; i < pages.length; i++) {
        pdf = await renderPageToPDF(pages[i], pdf);
        if(i < pages.length - 1) pdf.addPage();
    }

    const fileName = "تصريح دخول.pdf";
    const pdfBlob = pdf.output("blob");

    if (navigator.canShare && navigator.canShare({ files: [new File([pdfBlob], fileName, { type: "application/pdf" })] })) {
        const file = new File([pdfBlob], fileName, { type: "application/pdf" });
        await navigator.share({
            title: "تصريح دخول",
            text: "ملف تصريح دخول",
            files: [file]
        });
    } else {
        alert("متصفحك لا يدعم المشاركة المباشرة، سيتم تنزيل الملف بدلاً من ذلك.");
        pdf.save(fileName);
    }
}
</script>

</body>
</html>
